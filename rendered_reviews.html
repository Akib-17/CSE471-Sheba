<!DOCTYPE html>
<html>
<head>
    <title>Reviews</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem 0;
        }

        .reviews-container {
            max-width: 900px;
            margin: 0 auto;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .rating-header {
            background: white;
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            margin-bottom: 2rem;
            text-align: center;
        }

        .rating-header h3 {
            color: #667eea;
            font-weight: 700;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        .avg-rating-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .rating-number {
            font-size: 4rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1;
        }

        .rating-stars {
            font-size: 2.5rem;
            color: #fbbf24;
            display: flex;
            gap: 0.25rem;
        }

        .star {
            display: inline-block;
            transition: transform 0.3s ease;
        }

        .star:hover {
            transform: scale(1.2) rotate(15deg);
        }

        .star.empty {
            color: #e5e7eb;
        }

        .reviews-list {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-top: 1.5rem;
            padding-top: 0.5rem;
        }

        .review-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            opacity: 0;
            animation: fadeInUp 0.5s ease-out forwards;
            border: none;
        }

        .review-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.3);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .review-card:nth-child(1) { animation-delay: 0.1s; }
        .review-card:nth-child(2) { animation-delay: 0.2s; }
        .review-card:nth-child(3) { animation-delay: 0.3s; }
        .review-card:nth-child(4) { animation-delay: 0.4s; }
        .review-card:nth-child(5) { animation-delay: 0.5s; }

        .review-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .review-rating {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .review-rating-number {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .review-stars-small {
            font-size: 1.2rem;
            color: #fbbf24;
            display: flex;
            gap: 0.1rem;
        }

        .review-comment {
            color: #4a5568;
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .review-date {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #9ca3af;
            font-size: 0.875rem;
            font-style: italic;
        }

        .review-date::before {
            content: "üïí";
        }

        .empty-state {
            background: white;
            padding: 4rem 2rem;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .empty-state-icon {
            font-size: 5rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h4 {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: #9ca3af;
        }

        .filter-section {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .filter-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .filter-btn {
            padding: 0.6rem 1.25rem;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateY(-2px);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .rating-distribution {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid #f0f0f0;
        }

        .rating-bar {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .rating-label {
            font-weight: 600;
            color: #667eea;
            min-width: 60px;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .bar-container {
            flex: 1;
            height: 24px;
            background: #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            transition: width 1s ease-out;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 0.5rem;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .review-count {
            min-width: 40px;
            text-align: right;
            color: #6b7280;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .reviews-container {
                padding: 0 1rem;
            }

            .rating-header {
                padding: 1.5rem;
            }

            .rating-number {
                font-size: 3rem;
            }

            .rating-stars {
                font-size: 2rem;
            }

            .review-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="reviews-container">
        <div class="rating-header">
            <h3>‚≠ê Customer Reviews</h3>
            <div class="avg-rating-display">
                <div class="rating-number">5.0</div>
                <div class="rating-stars" id="avgStars"></div>
            </div>
            
            <div class="rating-distribution" id="ratingDistribution">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <div class="submit-review-section" style="margin:1.5rem 0;">
            <div class="review-card" style="padding:1rem;">
                <form id="reviewForm">
                    <div class="mb-3">
                        <label for="ratingSelect" class="form-label">Your Rating</label>
                        <select id="ratingSelect" name="rating" class="form-select" required>
                            <option value="">Select rating</option>
                            <option value="5">5 - Excellent</option>
                            <option value="4">4 - Very good</option>
                            <option value="3">3 - Good</option>
                            <option value="2">2 - Fair</option>
                            <option value="1">1 - Poor</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="comment" class="form-label">Your Review</label>
                        <textarea id="comment" name="comment" class="form-control" rows="3" required></textarea>
                    </div>
                    <input type="hidden" id="providerId" name="provider_id" value="1">
                    <input type="hidden" id="userId" name="user_id" value="1">
                    <button type="submit" class="btn btn-primary">Submit Review</button>
                    <div id="reviewMessage" style="margin-top:0.5rem;color:#1f2937;font-weight:600;"></div>
                </form>
            </div>
        </div>

        <div class="filter-section">
            <div class="filter-buttons">
                <button class="filter-btn active" data-rating="all">All Reviews</button>
                <button class="filter-btn" data-rating="5">‚≠ê 5 Stars</button>
                <button class="filter-btn" data-rating="4">‚≠ê 4 Stars</button>
                <button class="filter-btn" data-rating="3">‚≠ê 3 Stars</button>
                <button class="filter-btn" data-rating="2">‚≠ê 2 Stars</button>
                <button class="filter-btn" data-rating="1">‚≠ê 1 Star</button>
            </div>
        </div>

        <div class="reviews-list" id="reviewsList">
            
                <div class="review-card" data-rating="5">
                    <div class="review-header">
                        <div class="review-rating">
                            <span class="review-rating-number">5</span>
                            <div class="review-stars-small" data-rating="5"></div>
                        </div>
                        <div class="review-date">2025-12-26 05:32:10.525137</div>
                    </div>
                    <div class="review-comment">Test review</div>
                </div>
            
        </div>
    </div>

    <script>
        // Generate stars for average rating
        function generateStars(rating, container) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

            let starsHTML = '';
            for (let i = 0; i < fullStars; i++) {
                starsHTML += '<span class="star">‚òÖ</span>';
            }
            if (hasHalfStar) {
                starsHTML += '<span class="star">‚Ø®</span>';
            }
            for (let i = 0; i < emptyStars; i++) {
                starsHTML += '<span class="star empty">‚òÜ</span>';
            }

            container.innerHTML = starsHTML;
        }

        // Generate average rating stars
        const avgRating = parseFloat('5.0') || 0;
        const avgStarsContainer = document.getElementById('avgStars');
        if (avgStarsContainer) {
            generateStars(avgRating, avgStarsContainer);
        }

        // Generate stars for individual reviews
        document.querySelectorAll('.review-stars-small').forEach(container => {
            const rating = parseInt(container.dataset.rating);
            generateStars(rating, container);
        });

        // Filter functionality
        const filterButtons = document.querySelectorAll('.filter-btn');
        const reviewCards = document.querySelectorAll('.review-card');

        filterButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                filterButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                const filterRating = this.dataset.rating;
                
                reviewCards.forEach(card => {
                    if (filterRating === 'all' || card.dataset.rating === filterRating) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        });

        // Handle review submission via AJAX
        const reviewForm = document.getElementById('reviewForm');
        if (reviewForm) {
            reviewForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const rating = parseInt(document.getElementById('ratingSelect').value);
                const comment = document.getElementById('comment').value.trim();
                const provider_id = parseInt(document.getElementById('providerId').value) || 1;
                const user_id = parseInt(document.getElementById('userId').value) || 1;

                const msgEl = document.getElementById('reviewMessage');
                if (!rating) {
                    msgEl.textContent = 'Please select a rating.';
                    return;
                }

                msgEl.textContent = 'Submitting...';
                console.log('Submitting review:', { user_id, provider_id, rating, comment });
                console.log('API URL:', 'http://127.0.0.1:5000' + '/reviews/add');

                try {
                    const apiUrl = 'http://127.0.0.1:5000' + '/reviews/add';
                    const res = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id, provider_id, rating, comment })
                    });
                    
                    // Read response as text first, then parse as JSON
                    const responseText = await res.text();
                    let data = null;
                    try {
                        data = JSON.parse(responseText);
                    } catch (parseErr) {
                        // Show more detailed error information
                        const errorMsg = responseText 
                            ? `Server returned non-JSON (Status ${res.status}): ${responseText.substring(0, 100)}`
                            : `Server returned empty response (Status ${res.status})`;
                        msgEl.textContent = errorMsg;
                        console.error('Failed to parse response:', {
                            status: res.status,
                            statusText: res.statusText,
                            headers: Object.fromEntries(res.headers.entries()),
                            body: responseText
                        });
                        return;
                    }
                    
                    if (res.ok && data && data.ok) {
                        msgEl.textContent = 'Review submitted ‚Äî refreshing...';
                        setTimeout(() => location.reload(), 700);
                    } else {
                        msgEl.textContent = (data && data.message) ? data.message : 'Submission failed';
                    }
                } catch (err) {
                    msgEl.textContent = 'Network error: ' + err.message;
                    console.error('Network error details:', err);
                }
            });
        }

        // Generate rating distribution
        function generateRatingDistribution() {
            const reviews = document.querySelectorAll('.review-card');
            const distribution = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0};
            const total = reviews.length;

            reviews.forEach(review => {
                const rating = parseInt(review.dataset.rating);
                if (rating >= 1 && rating <= 5) {
                    distribution[rating]++;
                }
            });

            const distributionContainer = document.getElementById('ratingDistribution');
            if (total > 0 && distributionContainer) {
                let html = '';
                for (let i = 5; i >= 1; i--) {
                    const count = distribution[i];
                    const percentage = (count / total * 100).toFixed(0);
                    html += `
                        <div class="rating-bar">
                            <div class="rating-label">${i} ‚òÖ</div>
                            <div class="bar-container">
                                <div class="bar-fill" style="width: ${percentage}%">
                                    ${percentage > 10 ? percentage + '%' : ''}
                                </div>
                            </div>
                            <div class="review-count">${count}</div>
                        </div>
                    `;
                }
                distributionContainer.innerHTML = html;
            }
        }

        generateRatingDistribution();
    </script>
</body>
</html>